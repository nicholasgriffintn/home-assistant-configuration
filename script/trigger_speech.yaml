trigger_speech:
  mode: queued
  sequence:
    - condition: and
      conditions:
        - condition: or
          conditions:
            - condition: state
              entity_id: alarm_control_panel.london_alarm
              state: 'disarmed'
            - condition: state
              entity_id: input_boolean.guest_mode
              state: 'on'
        - condition: or
          conditions:
            - condition: and
              conditions:
                - condition: time
                  after: '08:00:00'
                  before: '22:00:00'
            - condition: state
              entity_id: input_boolean.alert_mode
              state: 'on'
        - condition: state
          entity_id: input_boolean.speech_notifications
          state: 'on'

    - service: media_player.volume_set
      data:
        entity_id: >
          {{ media_player }}
        volume_level: >-
          {% if now().strftime('%H')|int < 12 and now().strftime('%H')|int > 6 %}
            0.2
          {% elif now().strftime('%H')|int > 12 and now().strftime('%H')|int < 20 %}
            0.3
          {% else %}
            0.2
          {% endif %}

    - service: conversation.process
      data:
        agent_id: 01JS4DFR4SWX9W0RK7PDHRG1YH
        text: >-
          {{ speech_message }}
      response_variable: agent

    - action: assist_satellite.announce
      metadata: {}
      data:
        message: >-
          {{ agent.response.speech.plain.speech }}
        preannounce: true
      target:
        device_id: b2cd7d49f45144ddb35b315ebced9c2e
